# AI Development Rules for ESP32Tool

## Core Principle: Hardware Logic in esp_loader.ts

All hardware-related functionality, chip-specific logic, and serial communication must be implemented in `src/esp_loader.ts`. The UI layer (`js/script.js`) should only handle user interaction and call functions from the ESPLoader class.

## Rules

### 1. Function Implementation Location

**ALWAYS check `src/esp_loader.ts` first:**
- ✅ Does the needed function already exist? → Use it
- ❌ Function doesn't exist? → Create it in `esp_loader.ts`
- ❌ NEVER implement hardware logic in `js/script.js`

### 2. What Belongs in esp_loader.ts

- Serial port communication
- Chip detection and identification
- Reset strategies (bootloader, firmware, WDT)
- USB-JTAG/OTG handling
- Chip-specific behavior (ESP32-S2, ESP32-S3, ESP32-C3, etc.)
- Flash operations
- Stub loading
- Baudrate management
- Console mode entry/exit
- Connection state management

### 3. What Belongs in script.js

- UI event handlers (button clicks, file selection)
- DOM manipulation
- User feedback (logging, error messages)
- Modal dialogs
- Settings persistence (localStorage)
- Calling ESPLoader methods
- Event listener registration

### 4. Code Organization

```
esp32tool/
├── src/
│   ├── esp_loader.ts      ← Hardware logic, chip communication
│   ├── util.ts            ← Utility functions (toHex, sleep, formatMacAddr)
│   ├── const.ts           ← Constants and chip definitions
│   └── index.ts           ← Public API exports
└── js/
    └── script.js          ← UI logic, event handlers
```

### 5. Event-Driven Architecture

Use events for loose coupling between esp_loader.ts and script.js:

```typescript
// esp_loader.ts - Dispatch events
this.dispatchEvent(new CustomEvent("esp32s2-usb-reconnect", {
  detail: { message: "..." }
}));

// script.js - Listen to events
esploader.addEventListener("esp32s2-usb-reconnect", async () => {
  // Handle UI updates
});
```

### 6. Avoid Code Duplication

- ❌ Don't copy functions from `util.ts` to `script.js`
- ✅ Import and use exported functions from the esptool module
- ❌ Don't implement chip-specific logic twice
- ✅ Create reusable functions in `esp_loader.ts`

### 7. Example: Console Mode Exit

**❌ Wrong Approach:**
```javascript
// script.js - DON'T DO THIS
async function closeConsole() {
  if (isESP32S2) {
    // Trigger WDT reset
    // Handle port changes
    // Show modal
    // etc.
  }
}
```

**✅ Correct Approach:**
```typescript
// esp_loader.ts
async exitConsoleMode(): Promise<boolean> {
  if (isESP32S2 && isUsbJtagOrOtg) {
    this.dispatchEvent(new CustomEvent("esp32s2-usb-reconnect"));
    return true;
  }
  await this.reconnectToBootloader();
  return false;
}

// script.js
async function closeConsole() {
  const needsManualReconnect = await espLoaderBeforeConsole.exitConsoleMode();
  // Handle UI based on return value
}
```

## Benefits

- ✅ **Single Source of Truth:** Hardware logic exists in one place
- ✅ **Testability:** Core logic can be tested independently
- ✅ **Maintainability:** Changes only needed in one location
- ✅ **Consistency:** Both workspaces use the same implementation
- ✅ **Reusability:** Functions can be used across different UIs
- ✅ **Clear Separation:** UI concerns separated from hardware concerns

## Checklist for New Features

Before implementing a new feature, ask:

1. [ ] Does this involve hardware communication? → `esp_loader.ts`
2. [ ] Is this chip-specific behavior? → `esp_loader.ts`
3. [ ] Does a similar function already exist? → Reuse it
4. [ ] Is this UI-only logic? → `script.js`
5. [ ] Can this be made reusable? → Create in `esp_loader.ts`

## Common Patterns

### Pattern 1: Chip-Specific Behavior
```typescript
// esp_loader.ts
async handleChipSpecificOperation(): Promise<void> {
  switch (this.chipFamily) {
    case CHIP_FAMILY_ESP32S2:
      // ESP32-S2 specific logic
      break;
    case CHIP_FAMILY_ESP32S3:
      // ESP32-S3 specific logic
      break;
    default:
      // Generic logic
  }
}
```

### Pattern 2: Event-Based Communication
```typescript
// esp_loader.ts - Emit event
this.dispatchEvent(new CustomEvent("operation-complete", {
  detail: { result: data }
}));

// script.js - Handle event
esploader.addEventListener("operation-complete", (e) => {
  updateUI(e.detail.result);
});
```

### Pattern 3: Utility Function Reuse
```typescript
// util.ts
export const formatMacAddr = (macAddr: number[]): string => {
  return macAddr.map(v => v.toString(16).toUpperCase().padStart(2, "0")).join(":");
};

// script.js - Import from module
let formatMacAddr;
window.esptoolPackage.then((esptoolMod) => {
  formatMacAddr = esptoolMod.formatMacAddr;
});
```

## Version History

- 2026-01-25: Initial rules document created
- Focus: Hardware logic in esp_loader.ts, UI logic in script.js
